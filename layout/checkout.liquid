<!DOCTYPE html>

<html lang="{{ locale }}" dir="{{ direction }}" class="{{ checkout_html_classes }}">
  <head>
    <!-- liquid CO -->
          <!-- Global site tag (gtag.js) - Google Analytics 4 YOTAM->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F0MV256GM0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-F0MV256GM0');
</script-->
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, user-scalable=0">
    <meta name="referrer" content="origin">
     {%- if settings.favicon != blank -%}
    <link rel="shortcut icon" href="{{ settings.favicon | img_url: '32x32' }}" type="image/png">
    {%- endif -%}
    <title>{{ page_title }}</title>

    
    
    {{ content_for_header }}

    {{ checkout_stylesheets }}
    {{ checkout_scripts }}
  
  {% render 'shogun-head' %} 
    <!-- Curalife Shopify Redirect for checkout.shopify.com -->  
  {% include 'google-tag-manager-checkout-redirect'%}
    <!-- Curalife Shopify Only Google Tag Manager -->  
  {% include 'google-tag-manager'%}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <!-- Yotpo Modules Script -->
    <script src="https://cdn-widgetsrepository.yotpo.com/v1/loader/5AyB8SFKOjnnor-g4qIeMg" async></script>
</head>
<body>  
    {% for line_item in checkout.line_items %}
    {%- assign comma_list_append = ',' -%}
    {%- if forloop.last -%}
    {%- assign comma_list_append = '' -%}
    {%- endif -%}
    {%- assign productIds = productIds | append: line_item.product.id | append: comma_list_append -%}
    {% endfor %}
    
    {% assign product_ids = productIds | split: "," %}
    
      <!-- Curalife Shopify Only Google Tag Manager (noscript) -->
    {% include 'google-tag-manager-noscript.liquid' %}
    
    {{ skip_to_content_link }}

    <header class="banner" data-header role="banner">
      <div class="wrap">
        {{ content_for_logo }}
      </div>
    </header>

    {{ order_summary_toggle }}
    <div class="yotpo-widget-instance" data-yotpo-instance-id="18962"></div>
    <div class="content" data-content>
      <div class="wrap">
       
        <div class="main">
          <header class="main__header" role="banner">
            {{ content_for_logo }}
            {{ breadcrumb }}
            {{ alternative_payment_methods }}
          </header>
          <main class="main__content" role="main">
            {{ content_for_layout }}
            <div class="tc" style="display:flex;justify-content:flex-end;"><p style="margin-top:10px;">By clicking the continue button I Agree to CuraLife's <a href="https://curalife.com/policies/terms-of-service">Terms & Conditions</a>.</p></div>
          </main>
          <footer class="main__footer" role="contentinfo">
            {{ content_for_footer }}
          </footer>
        </div>
        <aside class="sidebar" role="complementary">
          <div class="sidebar__header">
            {{ content_for_logo }}
          </div>
          <div class="sidebar__content">
            {{ content_for_order_summary }}      
          </div>
          <div class="yotpo-widget-instance" data-yotpo-instance-id="35419"></div>
        </aside>
      </div>
    </div>

    {{ tracking_code }}

    <style>
      @media only screen and (min-width: 760px) {
    .tc p {
      max-width:180px;
    }
  }
      .btn {
        min-width: 180px;
      }
      
      #smsbump-consent-message {
        max-width: 200px;
        position: absolute;
      }
      </style>  
   
  <script>
    let utm_url = '&'
    let utm = location.search.split('utm')
	window.onload = function () {
      for (let i = 1; i < utm.length; i++) {
  		utm_url += 'utm' + utm[i];
		}
      $("form").each((form) => {
        $(this).attr("action", $(this).attr("action") + utm_url);
      });
    }
  </script>
   	<script async type="text/javascript" src="https://static.klaviyo.com/onsite/js/klaviyo.js?company_id=XWfxAu&module=CONSENT_AT_CHECKOUT"></script>
  	{% include 'smsbump_checkout_marketing_subscription' %}
  
<!-- Start of Woopra Code -->
<script>
  !function(){var t,o,c,e=window,n=document,r=arguments,a="script",i=["call","cancelAction","config","identify","push","track","trackClick","trackForm","update","visit"],s=function(){var t,o=this,c=function(t){o[t]=function(){return o._e.push([t].concat(Array.prototype.slice.call(arguments,0))),o}};for(o._e=[],t=0;t<i.length;t++)c(i[t])};for(e.__woo=e.__woo||{},t=0;t<r.length;t++)e.__woo[r[t]]=e[r[t]]=e[r[t]]||new s;(o=n.createElement(a)).async=1,o.src="https://static.woopra.com/js/w.js",(c=n.getElementsByTagName(a)[0]).parentNode.insertBefore(o,c)}("woopra");

  woopra.config({
    domain: "curalife.com",
    outgoing_tracking: true,
    download_tracking: true,
    click_tracking: true
  });

  {%- if checkout.email -%}
    woopra.identify({
      email: {{ checkout.email | json }}
    });
  {%- endif -%}

  {%- if customer -%}
  woopra.identify({
    customer_id: {{ customer.id | json }},
    name: {{ customer.name | json }},
    email: {{ customer.email | json }},              
    order_count: {{ customer.orders_count | json }},
    total_spent: {{ customer.total_spent | json }}
  });
  {%- endif -%}

  woopra.track();
</script>
<!-- End of Woopra Code -->
  
  <script>  
    items_data = [];
    {% for line_item in checkout.line_items %}
        var item = {
          item_id: '{{ line_item.product.id }}',
          item_name: '{{ line_item.product.title }}',
          affiliation: '{{ shop.name }}',
          price: parseFloat({{ line_item.product.price }} / 100.0).toFixed(2),
          currency: '{{ shop.currency }}',
          discount: {% if line_item.product.compare_at_price > 0 %} parseFloat(parseFloat({{ line_item.product.compare_at_price }} / 100.0) - parseFloat({{ line_item.product.price }} / 100.0)).toFixed(2) {% else %} "0.00" {% endif %},
          item_brand: 'CuraLife',            
          item_category: 'CuraLin',         
          quantity: {{ line_item.quantity }}
        }
        items_data.push(item);
    {% endfor %}
  
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const step = urlParams.get('step');

  if ((!window.location.href.includes('thank_you') && !window.location.href.includes("processing")) && step == null || step == 'contact_information') {
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          'event': 'CheckoutStarted',
          'step': '1',
          'content_type': 'product_group',    
          'content_ids': '[{{ productIds }}]',    //if multiple contents are in the cart on the checkout add an array of all products IDs
          'value': '{{ checkout.total_price | money_without_currency }}',
          'currency': '{{shop.currency}}',
          'userId': '{{ checkout.customer.id }}',
          'email': '{{ checkout.email }}',
          'city': '{{checkout.shipping_address.city }}',
          'country': '{{checkout.shipping_address.country_code }}',
          'name': '{{ checkout.shipping_address.first_name }}',
          'surname': '{{ checkout.shipping_address.last_name }}',
          'phone_number': '{{checkout.shipping_address.phone }}',
          'state': '{{checkout.shipping_address.province }}',       //state or province
          'zip': '{{checkout.shipping_address.zip }}',          //ZIP or Postal code
          'num_items': '{{ checkout.line_items.size }}'
         });

        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: 'begin_checkout',
          ecommerce: {                          
            items: items_data
          },
          user_email: '{{ customer.email }}',
          user_phone: '{{ customer.phone }}',
          user_first_name: '{{ customer.first_name }}',
          user_last_name: '{{ customer.last_name }}',
          user_city: '{{ customer.customer_address.city }}',
          user_state: '{{ customer.customer_address.province }}',
          user_zip: '{{ customer.customer_address.zip }}',
          user_country: '{{customer.customer_address.country_code | t}}',
          user_agent: navigator.userAgent
          //user_ip_address: 'insert_ip_address_here',
        });

        woopra.track('Checkout Step - Information', {page_url: window.location.href});
  }
  else if (step == 'shipping_method') {
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      'event': 'addShippingDetail',
      'step': '1',
      'content_type': 'product_group',    
      'content_ids': '[{{ productIds }}]',    //if multiple contents are in the cart on the checkout add an array of all products IDs
      'value': '{{ checkout.total_price | money_without_currency }}',
      'currency': '{{shop.currency}}',
      'userId': '{{ checkout.customer.id }}',
      'email': '{{ checkout.email }}',
      'city': '{{checkout.shipping_address.city }}',
      'country': '{{checkout.shipping_address.country_code }}',
      'name': '{{ checkout.shipping_address.first_name }}',
      'surname': '{{ checkout.shipping_address.last_name }}',
      'phone_number': '{{checkout.shipping_address.phone }}',
      'state': '{{checkout.shipping_address.province }}',       //state or province
      'zip': '{{checkout.shipping_address.zip }}',          //ZIP or Postal code
      'num_items': '{{ checkout.line_items.size }}'
 });
   
window.dataLayer = window.dataLayer || [];
window.dataLayer.push({
  event: 'add_shipping_info',
  ecommerce: {      
    shipping_tier: 'Free Shipping',                 
    items: items_data
  },
  user_email: '{{ customer.email }}',
  user_phone: '{{ customer.phone }}',
  user_first_name: '{{ customer.first_name }}',
  user_last_name: '{{ customer.last_name }}',
  user_city: '{{ customer.customer_address.city }}',
  user_state: '{{ customer.customer_address.province }}',
  user_zip: '{{ customer.customer_address.zip }}',
  user_country: '{{customer.customer_address.country_code | t}}',
  user_agent: navigator.userAgent
  //user_ip_address: 'insert_ip_address_here',
});

woopra.track('Checkout Step - Shipping', {});
  }
  else if (step == 'payment_method') {
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        'event': 'AddPaymentInfo',
        'step': '2',
        'content_type': 'product_group',    
        'content_ids': '[{{ productIds }}]',    //if multiple contents are in the cart on the checkout add an array of all products IDs
        'value': '{{ checkout.total_price | money_without_currency }}',
        'currency': '{{shop.currency}}',
        'userId': '{{ checkout.customer.id}}',
        'email': '{{ checkout.email }}',
        'city': '{{checkout.shipping_address.city }}',
        'country': '{{checkout.shipping_address.country_code}}',
        'name': '{{ checkout.shipping_address.first_name }}',
        'surname': '{{ checkout.shipping_address.last_name }}',
        'phone_number': '{{checkout.shipping_address.phone }}',
        'state': '{{checkout.shipping_address.province }}',       //state or province
        'zip': '{{checkout.shipping_address.zip }}',          //ZIP or Postal code
        'num_items': '{{ checkout.line_items.size }}'
      });

      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        event: 'add_payment_info',
        ecommerce: {      
          payment_type: '',                    
          items: items_data
        },
        user_email: '{{ customer.email }}',
        user_phone: '{{ customer.phone }}',
        user_first_name: '{{ customer.first_name }}',
        user_last_name: '{{ customer.last_name }}',
        user_city: '{{ customer.customer_address.city }}',
        user_state: '{{ customer.customer_address.province }}',
        user_zip: '{{ customer.customer_address.zip }}',
        user_country: '{{customer.customer_address.country_code | t}}',
        user_agent: navigator.userAgent
        //user_ip_address: 'insert_ip_address_here',
      });

      woopra.track('Checkout Step - Payment', {});
    }  
    else if (window.location.href.includes('thank_you')) {
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        'event': 'Purchase',
        'transaction_id': '{{checkout.order.name}}',      //order ID
        'content_type': 'product_group',
        'content_ids': '[{{ productIds }}]',      //if multiple conttent are purchased add array of all products IDs
        'value': '{{ checkout.total_price | money_without_currency }}',
        'currency': '{{shop.currency}}',
        'userId': '{{ checkout.customer.id }}',
        'email': '{{ checkout.email }}',
        'city': '{{checkout.shipping_address.city }}',
        'country': '{{checkout.shipping_address.country_code }}',
        'name': '{{ checkout.shipping_address.first_name }}',
        'surname': '{{ checkout.shipping_address.last_name }}',
        'phone_number': '{{checkout.shipping_address.phone }}',
        'state': '{{checkout.shipping_address.province }}',       //state or province
        'zip': '{{checkout.shipping_address.zip }}',          //ZIP or Postal code
        'num_items': '{{ checkout.line_items.size }}'
        });
       
        {% assign coupon = checkout.discount_applications | first %}
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: 'purchase', 
          ecommerce: {
            currency: '{{ shop.currency }}', 
            value: {{ checkout.total_price | money_without_currency }},
            tax: {{ checkout.tax_price | money_without_currency }},
            shipping: 0.00, 
            affiliation: '{{ shop.name }}',
            transaction_id: '{{ checkout.order.name }}',
            coupon: '{{ coupon.title }}',
            items: items_data
          },
          user_email: '{{ customer.email }}',
          user_phone: '{{ customer.phone }}',
          user_first_name: '{{ customer.first_name }}',
          user_last_name: '{{ customer.last_name }}',
          user_city: '{{ customer.customer_address.city }}',
          user_state: '{{ customer.customer_address.province }}',
          user_zip: '{{ customer.customer_address.zip }}',
          user_country: '{{customer.customer_address.country_code | t}}',
          user_agent: navigator.userAgent
          //user_ip_address: 'insert_ip_address_here',
        });

        woopra.track('Checkout Step - Thank You', {});
 };
</script>

<script> 
  // Track Discount Code
  var checker;  

  function trackApplyDiscount() {
    checker = setInterval(checkApplyDiscount, 200);
  }

  function checkApplyDiscount() {
    if (jQuery(".tag .reduction-code .reduction-code__text").length) {
      woopra.track('Apply Discount Code', {
        discount_code: jQuery(".tag .reduction-code .reduction-code__text").text()
      });
      clearInterval(checker);
      jQuery("#checkout_submit").click(trackApplyDiscount);
    }
    else if (jQuery("#error-for-reduction_code").length) {
      woopra.track('Apply Discount Code - Failed', {
        discount_code: jQuery("#checkout_reduction_code").attr("value"),
        error_message: jQuery("#error-for-reduction_code").text()
      });
      clearInterval(checker);
      jQuery("#checkout_submit").click(trackApplyDiscount);
    }
    else if (jQuery("#checkout_submit").hasClass("btn--disabled")) {
      woopra.track('Apply Discount Code - Failed', {
        discount_code: jQuery("#checkout_reduction_code").attr("value"),
        error_message: "No message displayed (but apply button disabled)"
      });        
      clearInterval(checker);
      jQuery("#checkout_submit").click(trackApplyDiscount);
    }
  }

  jQuery("#checkout_submit").click(trackApplyDiscount);

  // Track Login
  jQuery('a[href*="/account/login"]').click(function() {
    woopra.track('Checkout Login');
  })

  // Track Changing Billing Same/Different as Shipping
  jQuery('.section--billing-address input').click(function() {
    woopra.track('Billing Same/Different as Shipping Select', {
      option: $(this).val() == 'true' ? 'Different' : 'Same'
    })
  })

  jQuery('.section--billing-address label').click(function() {
    woopra.track('Billing Same/Different as Shipping Select', {
      option: $(this).att('for') == 'checkout_different_billing_address_true' ? 'Different' : 'Same'
    })
  })
</script>
  
  </body>
</html>
